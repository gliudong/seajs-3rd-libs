define("ucloud/backgrid/0.2.6/backgrid",["gallery/backbone/1.0.0/backbone","gallery/underscore/1.4.4/underscore","$","ucloud/jquery/1.8.2/jquery"],function(e,t,i){function r(e,t,i){var r=t-(e+"").length;r=0>r?0:r;for(var n="",o=0;r>o;o++)n+=i;return n+e}var n=e("gallery/backbone/1.0.0/backbone"),o=e("gallery/underscore/1.4.4/underscore"),s=e("ucloud/jquery/1.8.2/jquery"),l="	\n\f\r   ᠎             　\u2028\u2029";if(!String.prototype.trim||l.trim()){l="["+l+"]";var a=RegExp("^"+l+l+"*"),c=RegExp(l+l+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return(this+"").replace(a,"").replace(c,"")}}var h=root.Backgrid={VERSION:"0.3.0",Extension:{},requireOptions:function(e,t){for(var i=0;t.length>i;i++){var r=t[i];if(o.isUndefined(e[r]))throw new TypeError("'"+r+"' is required")}},resolveNameToClass:function(e,t){if(o.isString(e)){var i=o.map(e.split("-"),function(e){return e.slice(0,1).toUpperCase()+e.slice(1)}).join("")+t,r=h[i]||h.Extension[i];if(o.isUndefined(r))throw new ReferenceError("Class '"+i+"' not found");return r}return e},callByNeed:function(){var e=arguments[0];if(!o.isFunction(e))return e;var t=arguments[1],i=[].slice.call(arguments,2);return e.apply(t,i+""?i:void 0)}};o.extend(h,n.Events);var d=h.Command=function(e){o.extend(this,{altKey:!!e.altKey,"char":e["char"],charCode:e.charCode,ctrlKey:!!e.ctrlKey,key:e.key,keyCode:e.keyCode,locale:e.locale,location:e.location,metaKey:!!e.metaKey,repeat:!!e.repeat,shiftKey:!!e.shiftKey,which:e.which})};o.extend(d.prototype,{moveUp:function(){return 38==this.keyCode},moveDown:function(){return 40===this.keyCode},moveLeft:function(){return this.shiftKey&&9===this.keyCode},moveRight:function(){return!this.shiftKey&&9===this.keyCode},save:function(){return 13===this.keyCode},cancel:function(){return 27===this.keyCode},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var u=h.CellFormatter=function(){};o.extend(u.prototype,{fromRaw:function(e){return e},toRaw:function(e){return e}});var m=h.NumberFormatter=function(e){if(e=e?o.clone(e):{},o.extend(this,this.defaults,e),0>this.decimals||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};m.prototype=new u,o.extend(m.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(e){if(o.isNull(e)||o.isUndefined(e))return"";e=e.toFixed(~~this.decimals);var t=e.split("."),i=t[0],r=t[1]?(this.decimalSeparator||".")+t[1]:"";return i.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+r},toRaw:function(e){if(e=e.trim(),""===e)return null;for(var t="",i=e.split(this.orderSeparator),r=0;i.length>r;r++)t+=i[r];var n=t.split(this.decimalSeparator);t="";for(var r=0;n.length>r;r++)t=t+n[r]+".";"."===t[t.length-1]&&(t=t.slice(0,t.length-1));var s=1*(1*t).toFixed(~~this.decimals);return o.isNumber(s)&&!o.isNaN(s)?s:void 0}});var p=h.DatetimeFormatter=function(e){if(e=e?o.clone(e):{},o.extend(this,this.defaults,e),!this.includeDate&&!this.includeTime)throw Error("Either includeDate or includeTime must be true")};p.prototype=new u,o.extend(p.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(e,t){if(""===(e+"").trim())return null;var i,n=null;if(o.isNumber(e)){var s=new Date(e);i=r(s.getUTCFullYear(),4,0)+"-"+r(s.getUTCMonth()+1,2,0)+"-"+r(s.getUTCDate(),2,0),n=r(s.getUTCHours(),2,0)+":"+r(s.getUTCMinutes(),2,0)+":"+r(s.getUTCSeconds(),2,0)}else{e=e.trim();var l=e.split(this.ISO_SPLITTER_RE)||[];i=this.DATE_RE.test(l[0])?l[0]:"",n=i&&l[1]?l[1]:this.TIME_RE.test(l[0])?l[0]:""}var a=this.DATE_RE.exec(i)||[],c=this.TIME_RE.exec(n)||[];if(t){if(this.includeDate&&o.isUndefined(a[0]))return;if(this.includeTime&&o.isUndefined(c[0]))return;if(!this.includeDate&&i)return;if(!this.includeTime&&n)return}var s=new Date(Date.UTC(1*a[1]||0,1*a[2]-1||0,1*a[3]||0,1*c[1]||null,1*c[2]||null,1*c[3]||null,1*c[5]||null)),h="";return this.includeDate&&(h=r(s.getUTCFullYear(),4,0)+"-"+r(s.getUTCMonth()+1,2,0)+"-"+r(s.getUTCDate(),2,0)),this.includeTime&&(h=h+(this.includeDate?"T":"")+r(s.getUTCHours(),2,0)+":"+r(s.getUTCMinutes(),2,0)+":"+r(s.getUTCSeconds(),2,0),this.includeMilli&&(h=h+"."+r(s.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(h+="Z"),h},fromRaw:function(e){return o.isNull(e)||o.isUndefined(e)?"":this._convert(e)},toRaw:function(e){return this._convert(e,!0)}});var f=h.StringFormatter=function(){};f.prototype=new u,o.extend(f.prototype,{fromRaw:function(e){return o.isUndefined(e)||o.isNull(e)?"":e+""}});var g=h.EmailFormatter=function(){};g.prototype=new u,o.extend(g.prototype,{toRaw:function(e){var t=e.trim().split("@");return 2===t.length&&o.all(t)?e:void 0}});var v=h.SelectFormatter=function(){};v.prototype=new u,o.extend(v.prototype,{fromRaw:function(e){return o.isArray(e)?e:null!=e?[e]:[]}});var y=h.CellEditor=n.View.extend({initialize:function(e){h.requireOptions(e,["formatter","column","model"]),this.formatter=e.formatter,this.column=e.column,this.column instanceof $||(this.column=new $(this.column)),this.listenTo(this.model,"backgrid:editing",this.postRender)},postRender:function(e,t){return(null==t||t.get("name")==this.column.get("name"))&&this.$el.focus(),this}}),w=h.InputCellEditor=y.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(e){y.prototype.initialize.apply(this,arguments),e.placeholder&&this.$el.attr("placeholder",e.placeholder)},render:function(){return this.$el.val(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},saveOrCancel:function(e){var t=this.formatter,i=this.model,r=this.column,n=new d(e),s="blur"===e.type;if(n.moveUp()||n.moveDown()||n.moveLeft()||n.moveRight()||n.save()||s){e.preventDefault(),e.stopPropagation();var l=this.$el.val(),a=t.toRaw(l);o.isUndefined(a)?i.trigger("backgrid:error",i,r,l):(i.set(r.get("name"),a),i.trigger("backgrid:edited",i,r,n))}else n.cancel()&&(e.stopPropagation(),i.trigger("backgrid:edited",i,r,n))},postRender:function(e,t){if(null==t||t.get("name")==this.column.get("name"))if("right"===this.$el.css("text-align")){var i=this.$el.val();this.$el.focus().val(null).val(i)}else this.$el.focus();return this}}),b=h.Cell=n.View.extend({tagName:"td",formatter:new u,editor:w,events:{click:"enterEditMode"},initialize:function(e){h.requireOptions(e,["model","column"]),this.column=e.column,this.column instanceof $||(this.column=new $(this.column));var t=this.column,i=this.model,r=this.$el;this.formatter=h.resolveNameToClass(t.get("formatter")||this.formatter,"Formatter"),this.editor=h.resolveNameToClass(this.editor,"CellEditor"),this.listenTo(i,"change:"+t.get("name"),function(){r.hasClass("editor")||this.render()}),this.listenTo(i,"backgrid:error",this.renderError),this.listenTo(t,"change:editable change:sortable change:renderable",function(e){var t=e.changedAttributes();for(var i in t)t.hasOwnProperty(i)&&r.toggleClass(i,t[i])}),t.get("editable")&&r.addClass("editable"),t.get("sortable")&&r.addClass("sortable"),t.get("renderable")&&r.addClass("renderable")},render:function(){return this.$el.empty(),this.$el.text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this.delegateEvents(),this},enterEditMode:function(){var e=this.model,t=this.column,i=h.callByNeed(t.editable(),t,e);i&&(this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter}),e.trigger("backgrid:edit",e,t,this,this.currentEditor),this.undelegateEvents(),this.$el.empty(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),e.trigger("backgrid:editing",e,t,this,this.currentEditor))},renderError:function(e,t){(null==t||t.get("name")==this.column.get("name"))&&this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.remove(),this.stopListening(this.currentEditor),delete this.currentEditor,this.$el.removeClass("editor"),this.render()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this.currentEditor,arguments),delete this.currentEditor),n.View.prototype.remove.apply(this,arguments)}}),C=h.StringCell=b.extend({className:"string-cell",formatter:new f});h.UriCell=b.extend({className:"uri-cell",title:null,target:"_blank",initialize:function(e){b.prototype.initialize.apply(this,arguments),this.title=e.title||this.title,this.target=e.target||this.target},render:function(){this.$el.empty();var e=this.model.get(this.column.get("name")),t=this.formatter.fromRaw(e);return this.$el.append(s("<a>",{tabIndex:-1,href:e,title:this.title||t,target:this.target}).text(t)),this.delegateEvents(),this}}),h.EmailCell=C.extend({className:"email-cell",formatter:new g,render:function(){this.$el.empty();var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(s("<a>",{tabIndex:-1,href:"mailto:"+e,title:e}).text(e)),this.delegateEvents(),this}});var x=h.NumberCell=b.extend({className:"number-cell",decimals:m.prototype.defaults.decimals,decimalSeparator:m.prototype.defaults.decimalSeparator,orderSeparator:m.prototype.defaults.orderSeparator,formatter:m,initialize:function(){b.prototype.initialize.apply(this,arguments),this.formatter.fromRaw||this.formatter.toRaw||(this.formatter=new this.formatter({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator}))}});h.IntegerCell=x.extend({className:"integer-cell",decimals:0});var E=h.DatetimeCell=b.extend({className:"datetime-cell",includeDate:p.prototype.defaults.includeDate,includeTime:p.prototype.defaults.includeTime,includeMilli:p.prototype.defaults.includeMilli,formatter:p,initialize:function(){b.prototype.initialize.apply(this,arguments),this.formatter.fromRaw||this.formatter.toRaw||(this.formatter=new this.formatter({includeDate:this.includeDate,includeTime:this.includeTime,includeMilli:this.includeMilli}));var e=this.includeDate?"YYYY-MM-DD":"";e+=this.includeDate&&this.includeTime?"T":"",e+=this.includeTime?"HH:mm:ss":"",e+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:o.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:e})})}});h.DateCell=E.extend({className:"date-cell",includeTime:!1}),h.TimeCell=E.extend({className:"time-cell",includeDate:!1});var T=h.BooleanCellEditor=y.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=!0},blur:"enterOrExitEditMode",mouseup:function(){this.mouseDown=!1},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var e=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.prop("checked",e),this},enterOrExitEditMode:function(e){if(!this.mouseDown){var t=this.model;t.trigger("backgrid:edited",t,this.column,new d(e))}},saveOrCancel:function(e){var t=this.model,i=this.column,r=this.formatter,n=new d(e);if(n.passThru()&&"change"!=e.type)return!0;n.cancel()&&(e.stopPropagation(),t.trigger("backgrid:edited",t,i,n));var o=this.$el;if(n.save()||n.moveLeft()||n.moveRight()||n.moveUp()||n.moveDown()){e.preventDefault(),e.stopPropagation();var s=r.toRaw(o.prop("checked"));t.set(i.get("name"),s),t.trigger("backgrid:edited",t,i,n)}else if("change"==e.type){var s=r.toRaw(o.prop("checked"));t.set(i.get("name"),s),o.focus()}}});h.BooleanCell=b.extend({className:"boolean-cell",editor:T,events:{click:"enterEditMode"},render:function(){return this.$el.empty(),this.$el.append(s("<input>",{tabIndex:-1,type:"checkbox",checked:this.formatter.fromRaw(this.model.get(this.column.get("name")))})),this.delegateEvents(),this}});var R=h.SelectCellEditor=y.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:o.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>'),setOptionValues:function(e){this.optionValues=e},setMultiple:function(e){this.multiple=e,this.$el.prop("multiple",e)},_renderOptions:function(e,t){for(var i="",r=0;e.length>r;r++)i+=this.template({text:e[r][0],value:e[r][1],selected:t.indexOf(e[r][1])>-1});return i},render:function(){this.$el.empty();var e=o.result(this,"optionValues"),t=this.formatter.fromRaw(this.model.get(this.column.get("name")));if(!o.isArray(e))throw new TypeError("optionValues must be an array");for(var i=null,r=null,i=null,n=null,l=null,a=0;e.length>a;a++){var i=e[a];if(o.isArray(i))r=i[0],i=i[1],this.$el.append(this.template({text:r,value:i,selected:t.indexOf(i)>-1}));else{if(!o.isObject(i))throw new TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");n=i.name,l=s("<optgroup></optgroup>",{label:n}),l.append(this._renderOptions(i.values,t)),this.$el.append(l)}}return this.delegateEvents(),this},save:function(e){var t=this.model,i=this.column;t.set(i.get("name"),this.formatter.toRaw(this.$el.val())),t.trigger("backgrid:edited",t,i,new d(e))},close:function(e){var t=this.model,i=this.column,r=new d(e);r.cancel()?(e.stopPropagation(),t.trigger("backgrid:edited",t,i,new d(e))):(r.save()||r.moveLeft()||r.moveRight()||r.moveUp()||r.moveDown()||"blur"==e.type)&&(e.preventDefault(),e.stopPropagation(),"blur"==e.type&&1===this.$el.find("option").length&&t.set(i.get("name"),this.formatter.toRaw(this.$el.val())),t.trigger("backgrid:edited",t,i,new d(e)))}});h.SelectCell=b.extend({className:"select-cell",editor:R,multiple:!1,formatter:new v,optionValues:void 0,delimiter:", ",initialize:function(){b.prototype.initialize.apply(this,arguments),h.requireOptions(this,["optionValues"]),this.listenTo(this.model,"backgrid:edit",function(e,t,i,r){t.get("name")==this.column.get("name")&&(r.setOptionValues(this.optionValues),r.setMultiple(this.multiple))})},render:function(){this.$el.empty();var e=this.optionValues,t=this.formatter.fromRaw(this.model.get(this.column.get("name"))),i=[];try{if(!o.isArray(e)||o.isEmpty(e))throw new TypeError;for(var r=0;t.length>r;r++)for(var n=t[r],s=0;e.length>s;s++){var l=e[s];if(o.isArray(l)){var a=l[0],l=l[1];l==n&&i.push(a)}else{if(!o.isObject(l))throw new TypeError;for(var c=l.values,h=0;c.length>h;h++){var d=c[h];d[1]==n&&i.push(d[0])}}}this.$el.append(i.join(this.delimiter))}catch(u){if(u instanceof TypeError)throw new TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}");throw u}return this.delegateEvents(),this}});var $=h.Column=n.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,sortValue:void 0,cell:void 0,headerCell:void 0},initialize:function(e){h.requireOptions(e,["cell","name"]),this.has("label")||this.set({label:this.get("name")},{silent:!0});var t=h.resolveNameToClass(this.get("headerCell"),"HeaderCell"),i=h.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:i,headerCell:t},{silent:!0})},sortValue:function(){var e=this.get("sortValue");return o.isString(e)?this[e]:o.isFunction(e)?e:function(e,t){return e.get(t)}}});o.each(["sortable","renderable","editable"],function(e){$.prototype[e]=function(){var t=this.get(e);return o.isString(t)?this[t]:!!t}});var k=h.Columns=n.Collection.extend({model:$}),N=h.Row=n.View.extend({tagName:"tr",requiredOptions:["columns","model"],initialize:function(e){h.requireOptions(e,this.requiredOptions);var t=this.columns=e.columns;t instanceof n.Collection||(t=this.columns=new k(t));for(var i=this.cells=[],r=0;t.length>r;r++)i.push(this.makeCell(t.at(r),e));this.listenTo(t,"add",function(t,r){var n=r.indexOf(t),o=this.makeCell(t,e);i.splice(n,0,o);var s=this.$el;0===n?s.prepend(o.render().$el):n===r.length-1?s.append(o.render().$el):s.children().eq(n).before(o.render().$el)}),this.listenTo(t,"remove",function(e,t,r){i[r.index].remove(),i.splice(r.index,1)})},makeCell:function(e){return new(e.get("cell"))({column:e,model:this.model})},render:function(){this.$el.empty();for(var e=document.createDocumentFragment(),t=0;this.cells.length>t;t++)e.appendChild(this.cells[t].render().el);return this.el.appendChild(e),this.delegateEvents(),this},remove:function(){for(var e=0;this.cells.length>e;e++){var t=this.cells[e];t.remove.apply(t,arguments)}return n.View.prototype.remove.apply(this,arguments)}}),D=h.EmptyRow=n.View.extend({tagName:"tr",emptyText:null,initialize:function(e){h.requireOptions(e,["emptyText","columns"]),this.emptyText=e.emptyText,this.columns=e.columns},render:function(){this.$el.empty();var e=document.createElement("td");return e.setAttribute("colspan",this.columns.length),e.textContent=this.emptyText,this.el.setAttribute("class","empty"),this.el.appendChild(e),this}}),O=h.HeaderCell=n.View.extend({tagName:"th",events:{"click a":"onClick"},_direction:null,initialize:function(e){h.requireOptions(e,["column","collection"]),this.column=e.column,this.column instanceof $||(this.column=new $(this.column)),this.listenTo(this.collection,"backgrid:sort",this._resetCellDirection);var t=this.column,i=this.$el;this.listenTo(t,"change:editable change:sortable change:renderable",function(e){var t=e.changedAttributes();for(var r in t)t.hasOwnProperty(r)&&i.toggleClass(r,t[r])}),t.get("editable")&&i.addClass("editable"),t.get("sortable")&&i.addClass("sortable"),t.get("renderable")&&i.addClass("renderable")},direction:function(e){return arguments.length&&(this._direction&&this.$el.removeClass(this._direction),e&&this.$el.addClass(e),this._direction=e),this._direction},_resetCellDirection:function(e,t,i,r){r==this.collection&&(e!==this.column?this.direction(null):this.direction(t))},onClick:function(e){function t(e,t){"ascending"===e.direction()?e.sort(t,"descending"):"descending"===e.direction()?e.sort(t,null):e.sort(t,"ascending")}function i(e,t){"ascending"===e.direction()?e.sort(t,"descending"):e.sort(t,"ascending")}e.preventDefault();var r=this.column,n=h.callByNeed(r.sortable(),r,this.model);if(n){var o=r.get("sortType");"toggle"===o?i(this,r):t(this,r)}},sort:function(e,t){var i,r=this.collection;i="ascending"===t?-1:"descending"===t?1:null;var o=this.makeComparator(e.get("name"),i,i?e.sortValue():function(e){return e.cid});n.PageableCollection&&r instanceof n.PageableCollection?(r.setSorting(i&&e.get("name"),i,{sortValue:e.sortValue()}),"client"==r.mode?(null==r.fullCollection.comparator&&(r.fullCollection.comparator=o),r.fullCollection.sort()):r.fetch({reset:!0})):(r.comparator=o,r.sort()),this.collection.trigger("backgrid:sort",e,t,o,this.collection)},makeComparator:function(e,t,i){return function(r,n){var o,s=i(r,e),l=i(n,e);return 1===t&&(o=s,s=l,l=o),s===l?0:l>s?-1:1}},render:function(){this.$el.empty();var e=s("<a>").text(this.column.get("label")),t=h.callByNeed(this.column.sortable(),this.column,this.model);return t&&e.append("<b class='sort-caret'></b>"),this.$el.append(e),this.delegateEvents(),this}});h.HeaderRow=h.Row.extend({requiredOptions:["columns","collection"],initialize:function(){h.Row.prototype.initialize.apply(this,arguments)},makeCell:function(e,t){var i=e.get("headerCell")||t.headerCell||O;return i=new i({column:e,collection:this.collection})}});var M=h.Header=n.View.extend({tagName:"thead",initialize:function(e){h.requireOptions(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new k(this.columns)),this.row=new h.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.$el.append(this.row.render().$el),this.delegateEvents(),this},remove:function(){return this.row.remove.apply(this.row,arguments),n.View.prototype.remove.apply(this,arguments)}}),U=h.Body=n.View.extend({tagName:"tbody",initialize:function(e){h.requireOptions(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new k(this.columns)),this.row=e.row||N,this.rows=this.collection.map(function(e){var t=new this.row({columns:this.columns,model:e});return t},this),this.emptyText=e.emptyText,this._unshiftEmptyRowMayBe();var t=this.collection;this.listenTo(t,"add",this.insertRow),this.listenTo(t,"remove",this.removeRow),this.listenTo(t,"sort",this.refresh),this.listenTo(t,"reset",this.refresh),this.listenTo(t,"backgrid:edited",this.moveToNextCell)},_unshiftEmptyRowMayBe:function(){0===this.rows.length&&null!=this.emptyText&&this.rows.unshift(new D({emptyText:this.emptyText,columns:this.columns}))},insertRow:function(e,t,i){if(this.rows[0]instanceof D&&this.rows.pop().remove(),!(t instanceof n.Collection||i))return this.collection.add(e,i=t),void 0;i=o.extend({render:!0},i||{});var r=new this.row({columns:this.columns,model:e}),s=t.indexOf(e);this.rows.splice(s,0,r);var l=this.$el,a=l.children(),c=r.render().$el;i.render&&(s>=a.length?l.append(c):a.eq(s).before(c))},removeRow:function(e,t,i){return i?((o.isUndefined(i.render)||i.render)&&this.rows[i.index].remove(),this.rows.splice(i.index,1),this._unshiftEmptyRowMayBe(),void 0):(this.collection.remove(e,i=t),this._unshiftEmptyRowMayBe(),void 0)},refresh:function(){for(var e=0;this.rows.length>e;e++)this.rows[e].remove();return this.rows=this.collection.map(function(e){var t=new this.row({columns:this.columns,model:e});return t},this),this._unshiftEmptyRowMayBe(),this.render(),this.collection.trigger("backgrid:refresh",this),this},render:function(){this.$el.empty();for(var e=document.createDocumentFragment(),t=0;this.rows.length>t;t++){var i=this.rows[t];e.appendChild(i.render().el)}return this.el.appendChild(e),this.delegateEvents(),this},remove:function(){for(var e=0;this.rows.length>e;e++){var t=this.rows[e];t.remove.apply(t,arguments)}return n.View.prototype.remove.apply(this,arguments)},moveToNextCell:function(e,t,i){var r,n,o,s=this.collection.indexOf(e),l=this.columns.indexOf(t);if(this.rows[s].cells[l].exitEditMode(),i.moveUp()||i.moveDown()||i.moveLeft()||i.moveRight()||i.save()){var a=this.columns.length,c=a*this.collection.length;if(i.moveUp()||i.moveDown()){var d=this.rows[s+(i.moveUp()?-1:1)];d&&(r=d.cells[l],h.callByNeed(r.column.editable(),r.column,e)&&r.enterEditMode())}else if(i.moveLeft()||i.moveRight())for(var u=i.moveRight(),m=s*a+l+(u?1:-1);m>=0&&c>m;u?m++:m--){var p=~~(m/a),f=m-p*a;if(r=this.rows[p].cells[f],n=h.callByNeed(r.column.renderable(),r.column,r.model),o=h.callByNeed(r.column.editable(),r.column,e),n&&o){r.enterEditMode();break}}}}});h.Footer=n.View.extend({tagName:"tfoot",initialize:function(e){h.requireOptions(e,["columns","collection"]),this.columns=e.columns,this.columns instanceof n.Collection||(this.columns=new h.Columns(this.columns))}}),h.Grid=n.View.extend({tagName:"table",className:"backgrid",header:M,body:U,footer:null,initialize:function(e){h.requireOptions(e,["columns","collection"]),e.columns instanceof n.Collection||(e.columns=new k(e.columns)),this.columns=e.columns;var t=o.omit(e,["el","id","attributes","className","tagName","events"]);this.header=e.header||this.header,this.header=new this.header(t),this.body=e.body||this.body,this.body=new this.body(t),this.footer=e.footer||this.footer,this.footer&&(this.footer=new this.footer(t)),this.listenTo(this.columns,"reset",function(){this.header=new(this.header.remove().constructor)(t),this.body=new(this.body.remove().constructor)(t),this.footer&&(this.footer=new(this.footer.remove().constructor)(t)),this.render()})},insertRow:function(e,t,i){return this.body.insertRow(e,t,i)},removeRow:function(e,t,i){return this.body.removeRow(e,t,i)},insertColumn:function(e,t){return t=t||{render:!0},this.columns.add(e,t),this},removeColumn:function(e,t){return this.columns.remove(e,t),this},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.delegateEvents(),this.trigger("backgrid:rendered",this),this},remove:function(){return this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),n.View.prototype.remove.apply(this,arguments)}}),i.exports=h});
